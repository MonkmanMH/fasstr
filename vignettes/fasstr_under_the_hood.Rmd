---
title: "Under the fasstr Hood"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r options, include=FALSE}
#knitr::opts_chunk$set(eval = nzchar(Sys.getenv("hydat_eval")))
```

```{r, include=FALSE}
#library(fasstr)
```


The Flow Analysis Summary Statistics Tool for R (`fasstr`) is a set of [R](http://www.r-project.org) functions to tidy, summarize, analyze, trend, and visualize streamflow data. This package summarizes continuous daily mean streamflow data into various daily, monthly, annual, and long-term statistics, completes annual trends and frequency analyses, in both table and plot formats.

This vignette guide contains a look at the steps and internal functions used within the various fasstr functions. It includes descriptions of the function and steps on data importing (), cleaning and wrangling, filtering, analyzing, and plotting.


### Data Importing and Checking

The fasstr functions primarily require daily mean streamflow data in cubic metres per second. As such, columns of dates and values are required. Many fasstr functions can analyze multiple stations (using grouping functions) so a column to group data by (typically station numbers) can be provided. Other types of data can be used (climate, water level, etc), but plots and some conversions are based on the units of discharge. As there are two ways to provide daily data to the fasstr functions, the "data" and the "station_number" arguments, there are several internal functions stored in the utils.R file that checks the data and formats the columns to ensure the data is prepared for the analysis. The following describes the steps to ensure data is consistently set up for analysis.

The first step is to import daily data. The internal flowdata_import() function provides checks on the "data" and "station_number" arguments, and either extracts daily data from HYDAT (returns an error if the number isn't in HYDAT), or makes sure that "data" is in fact a data frame.

At this point in a fasstr function, all the column names of the data are saved as in a vector and any grouping (tidy grouping) is removed. The column names are saved as they may be changed in the following steps and the original names will be returned at the end of the analysis.  Any grouping is removed to allow for the appropriate grouping of the analysis. For the cleaning functions (add_ and fill_) any grouping will be returned.

The next step is to ensure the column names of dates, values, and groups are consistent as "Date", "Value", and "STATION_NUMBER" (to match the HYDAT outputs), respectively, for the analysis. This is required as grouping and summarizing functions in the following steps use these specific column names, and provided data may not use the same names. The faciliate the column renaming and checking, there are several internal functions in the utils.R. For each of the three columns there is a function that checks if it exists, the proper formatting, and renames the columns to the appropraite name.  These functions are format_dates_col(), format_values_col(), and format_groups_col(). If no grouping is provided, a fake STATION_NUMBER of "XXXXXXX" is provided (and removed at the end of the fasstr function). As all three columns are required for many fasstr functions, there is a formal_all_cols() that uses all three fucntions, with an option to remove all other columns.

At this point in a function there is now a data frame of data, usually called flow_data that has three columns of "Date", "Value", and "STATION_NUMBER", that is ready to be cleaned for analysis.

Note: some functions use different data sources than daily data. The compute_HYDAT_peaks_frequencies() does not permit the "data" argument and just extracts data from HYDAT (and sets it up appropriately) and the compute_frequency_analysis() function requires a unique dataset (see ?compute_frequency_analysis for more information on the function).



### Cleaning Functions (add_ and fill_)

The fasstr cleaning functions (start with add_ or fill_) just add rows or columns of data so there are fewer steps than the other fasstr functions.

After the data has been prepped with the appropriate columns, the columns are added with their equations or other functions, or dates are filled with NA if they are missing. Then if any of the column names were changed in the formatting, they are returned to their original names, and if there was a grouping beforehand, that grouping is returned.



### Analysis Functions (calc_ and compute_)

The fasstr analysis functions (start with calc_ or compute_ or screen_) require steps of cleaning (adding appropriate columns), filtering, analyzing and any final data wrangling.


#### Data Cleaning and Preparing

After the data has been prepped with the appropriate columns, additional columns of dates (years, months, days), rolling days, basin areas, yields or volumes may be added, depending on the analysis. Dates with no data are also filled with NA values so that complete years can be analyzed (and appropriate warnings made if NA's are produced). To facilitate these steps there is an internal function in the utils.R file called analysis_prep().  This function will fill the missing dates and add colums of Years, Months, DayofYears, and Dates to the data frame.  It also creates columns called AnalysisYear, AnalysisDoY, and AnalysisDate, that extracts the date variables from the appropriate calendar or water years date columns. This is to provide consistency to the analysis functions (as Year or WaterYear could be used depending on the water_year argument choice). The analysis date columns are ultimately returned to their original names (Year, DayofYear, Date) in the results. Any other columns are added as necessary using the necessary cleaning functions.

At this point in a function the data frame of data, flow_data, has three columns of "Date", "Value", and "STATION_NUMBER", and any other date and necessary column required to be filtered for analysis.


#### Data Filtering

With all the necessary columns of data for analysis, the data can be filtered for the years, months, dates, etc as specified in the fasstr function arguments.  These are mostly completed with simple tidy filtering functions. However when using the complete_years argument in some of the fasstr functions, there is an internal function in the utils.R file called filter_complete_yrs() that removes data from years with incomplete data.

At this point in a function the data frame of data, flow_data, has three columns of "Date", "Value", and "STATION_NUMBER", and any other date and necessary column, and is filtered for the analysis.


#### Calculating Statistics

Now that the data contains all the necessary data to summarize, using the tidy methods of the tidyverse (predominately tidyr and dplyr packages), data is grouped by the necessary variables. Data is usually grouped by STATION_NUMBER and then whatever time-frame variable the function calls for (years, months, days, etc).

Then the data is typically analyzed using the dplyr::summarize() function (for means, median, minimums, etc).  If an analysis considers if missing data is available or not, then the na.rm argument is set to the ignore_missing function provided in the fasstr functions. If NAN or Inf values are produced in the results, then they are replaced with NA for consistency. If percentiles are being calculated, another code chunk will loop through each percentile selected and attach to the data.

Data is then ungrouped to allow for further data wrangling and outputting.


#### Final Data Wrangling

To finalize the data results there are usually some final data filtering or wrangling steps. Some of these include some additonal filtering (usually when using the exclude_years argument; replaces data with NA), providing warnings if NA's are produced in the data, renaming the analysis date columns (AnalysisYear to Year; as reversing above cleaning functions), and returning the names of the groups (i.e. STATION_NUMBER column) if different, or removing it if it wasn't provided (as listed in the original column names vector described above).

If the option to transpose the results data was set to TRUE with the transpose argument, then the data is gathered and spread such that each statistics is a single row as opposed to a column in the original results.

After all wrangling, the final results are returned from the function as a tibble.


### Plotting Functions (plot_)

The fasstr plotting functions (start with plot_) take the data calculated in the analysis functions and then plot the data with set or custom plotting templates.

#### Calculating Statistics

using flowdata_import() function to get the HYDAT or data frame and set all data to Date, Value, and STATION_NUMBER columns using the format_all_cols() function.

Then using the appropriate fasstr function, the statistics are calculated. Any final data wrangling is also completed to set it up for the plotting functions.

#### Plotting Statistics

Some variables may be created for labeling

As many plots may be created, fasstr function utilize tidyverse packages (dplyr, tidyr, and purrr) to create a tibble of plots.  See this [link](http://www.brodrigues.co/blog/2017-03-29-make-ggplot2-purrr/) for more information on the methods.

- setting some plotting objects (labels etc)
- create a tibble of plots
    - group by station_number
    - nest
    - new column using purrr to create plots
- grab column of plots into list with names




## utils.R functions

R file for list of functions that are used repeatedly throughout the various fasstr functions and to minimize repitition.

Several data formatting and wrangling functions

- **flowdata_import()** - checks if either `station_number` or `data` arguments are provided; extracts HYDAT data or sets up data for next steps.
- **format_dates_col()** - checks for proper dates formats in column; renames columns to "Date" if not.
- **format_values_col()** - checks for proper numeric formats in column; renames columns to "Value" if not.
- **format_groups_col()** - checks for proper formats in column; renames columns to "STATION_NUMBER" if not; if no groups provided, a temporary STATION_NUMBER of "XXXXXXX" is created for analysis.
- **format_all_cols()** - checks for proper formats of all dates, values, and groups columns; uses all three functions listed above; option to remove all other columns if `rm_other_cols = TRUE`.
- **analysis_prep()** - fills missing dates with NA; adds dates columns of Years, day of years, and dates; formatted to calendar or water year as specified.
- **filter_complete_yrs()** - filters data for years with which there is only complete annual data; required for some analyses.

Most other functions in utils.R are argument checks.



## Documentation

Many of the arguments are described in the calc_annual_stats() and plot_annual_stats() functions, and many of the functions reference their argument descriptions using @inheritParams, unless there are specific arguments to describe for a function. 



