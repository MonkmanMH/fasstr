---
title: "How to use fasstr"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r options, include=FALSE}
knitr::opts_chunk$set(eval = nzchar(Sys.getenv("hydat_eval")))
```

## Installation

To install the `fasstr` package, you need to install the `devtools` package then the `fasstr` package
```{r, echo=TRUE, eval=FALSE}
install.packages("devtools")
devtools::install_github("bcgov/fasstr")
```
  
Then to call the `fasstr` functions you can either load the package using the `library()` function or access a specific function using a double-colon (e.g. `fasstr::calc_daily_stats()`). Several other packages will be installed in addition to this package including [zyp](https://cran.r-project.org/web/packages/zyp/index.html) for trending, [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html) for creating plots, and [dplyr](https://cran.r-project.org/web/packages/dplyr/index.html) and [tidyr](https://cran.r-project.org/web/packages/tidyr/index.html) for various data wrangling and summarizing functions, amongst others.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(fasstr)
library(dplyr)
```


To use the `HYDAT` arguments of the `fasstr` functions, you will need to download the `tidyhydat` package and a HYDAT database. Installation instructions for both can be found [here](https://github.com/ropensci/tidyhydat).
  

## Usage


### Flow Data Input

All functions in `fasstr` require a record of daily mean streamflow from a hydrometric station. Long-term and continuous datasets are preferred for most analyses, but seasonal and partial data can be used.

Flow data can be provided to the functions through either the `HYDAT` or `flowdata` arguments. When using the `HYDAT` argument, a Water Survey of Canada station number is required (e.g. `HYDAT="08NM116"`) and its corresponding historical daily streamflow record is extracted from HYDAT using `tidyhydat`. [Installation](https://github.com/ropensci/tidyhydat) of both `tidyhydat` and a HYDAT database is required to use this argument.

Data can alternatively be provided using the `flowdata` argument as a dataframe with columns of 'Date' (YYYY-MM-DD in date format) and 'Value' (mean daily discharge in cubic metres per second in numeric format). The dataframe can have other columns with other names as the functions will looks for 'Date' and 'Value'. The `fasstr` functions will not recognize your dates and flow data if the columns are not appropriately named 'Date' and 'Value'. The following is an example of an appropriate flowdata dataframe:
```{r setup, include=FALSE}
flowdata <- tidyhydat::hy_daily_flows("08HB048")
flowdata <- select(flowdata, Date, Value)
```

```{r flowdata, warning=FALSE}
glimpse(flowdata)
```

## Examples

### Data prep functions

There are several functions that are used to prepare a flow dataset for analysis.  These functions start with `add_` or `fill_` and add rows and columns to your flow dataframe (either from `flow_data` or `HYDAT`).  The function are set up to use the tidy methods with pipes allowing for ease of use.
```{r exampletidy, warning=FALSE, width=Inf}
fill_missing_dates(station_number = "08HB048") %>% 
  select(Date,Value) %>% 
  add_date_variables() %>% 
  add_rolling_means(roll_days = 7)
```


### Summary statistics example: long-term statistics

To determine the summary statistics of an entire dataset and by month (mean, median, maximum, minimum, and some percentiles) you can use the `calc_longterm_stats()` function. If the 'Mission Creek near East Kelowna' hydrometric station is of interest you can list the station number in the `HYDAT` argument to obtain the data (if `tidyhydat` and HYDAT are installed). 

```{r example1, warning=FALSE, eval=FALSE}
calc_longterm_stats(station_number = "08NM116")
```

### Plotting example 1: daily summary statistics

To visualize the daily streamflow patterns on an annual basis, the `plot_daily_stats()` function will plot out various summary statistics for each day of the year. Data can also be filtered for certain years of interest (a 1981-2010 normals period for this example) using the `start_year` and `end_year` arguments. Multiple plots are produced with this function, so this example plots just the summary statistics (`[1]`).

```{r plot1, warning=FALSE, eval = FALSE, fig.height = 4, fig.width = 10}
plot_daily_stats(station_number = "08NM116",
                 start_year = 1981,
                 end_year = 2010,
                 log_discharge = TRUE)[1]
```

### Plotting example 2: flow duration curves

Flow duration curves can be produced using the `plot_flow_duration()` function.

```{r plot2, warning=FALSE, eval = FALSE, fig.height = 4, fig.width = 7}
plot_flow_duration(station_number = "08NM116",
                   start_year = 1981,
                   end_year = 2010)
```

### Analysis example: low-flow frequency analysis

This package also provides a function, `compute_frequency_analysis()`, to complete frequency analyses (using the same methods as [HEC-SSP](http://www.hec.usace.army.mil/software/hec-ssp/)). The default fitting distribution is 'log-Pearson Type III', but the 'weibull' distribution can also be used. Other default plotting and fitting methods are described in the function documentation. For this example, the 7-day low-flow (low-flow is default) quantiles are calculated for the Mission Creek hydrometric station using the 'log-Pearson Type III' distribution. With this, several low-flow indicators can be determined (i.e. 7Q5, 7Q10).

```{r example2, eval= FALSE, warning=FALSE}
compute_frequency_analysis(station_number = "08NM116",
                           start_year = 1981,
                           end_year = 2010,
                           rolling_days=7)[5]
```

