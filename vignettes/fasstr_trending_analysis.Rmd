---
title: "'fasstr' Trending Analysis"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r options, include=FALSE}
knitr::opts_chunk$set(eval = nzchar(Sys.getenv("hydat_eval")))
```

```{r, include=FALSE}
library(fasstr)
```


The Flow Analysis Summary Statistics Tool for R (`fasstr`) is a set of [R](http://www.r-project.org) functions to tidy, summarize, analyze, trend, and visualize streamflow data. This package summarizes continuous daily mean streamflow data into various daily, monthly, annual, and long-term statistics, completes annual trends and frequency analyses, in both table and plot formats.

This vignette guide contains a brief guide on the trending analysis functions found in `fasstr`.

1. Trending Methodology
2. Computing Trends
3. Plotting Trends



## 1. Trending Methodology

Non-parametric
Mann Kendall
Sen's slope

Autocorrelation

`zyp` package as the engine

And these are used in the analysis:

- `compute_annual_trends()` - calculate prewhitened nonlinear annual trends on streamflow data
- `plot_annual_trends()` - plot prewhitened nonlinear annual trends on streamflow data

## 2. Computing Trends

function and arguments


`zyp_method` "yuepilon" or "zhang"



computes all annual metrics from:
- `calc_annual_stats()` - calculate annual summary statistics
- `calc_annual_cumulative_stats()` - calculate annual and seasonal cumulative flows, both volume and yield
- `calc_annual_flow_timing()` - calculate annual flow timing
- `calc_annual_lowflows()` - calculate annual lowflows
- `calc_annual_outside_normal()` - calculate annual days above and below normal
- `calc_monthly_stats()` - calculate monthly summary statistics

While they all have defaults, they can be customized using the following arguments:

Argument             | Corresponding Function     |  Default
---------------------|----------------------|----------------------------------------------
annual_percentiles   | calc_annual_stats()  | c(10,90)
monthly_percentiles  | calc_monthly_stats() | c(10,20)
stats_days       	   | calc_annual_stats() & calc_monthly_stats() | 1
stats_align      	   | calc_annual_stats() & calc_monthly_stats() | "right"
lowflow_days      	 | calc_annual_lowflows | c(1,3,7,30)
lowflow_align        | calc_annual_lowflows | "right"
timing_percent       | calc_annual_flow_timing | c(25,33.3,50,75)
normal_percentiles   | calc_annual_outside_normal | c(25,75)


Completing the function will result in a tibble with the following columns:

Column Name   | Description
--------------|---------------------------------------------------------------------
Statistic   	| the annual statistic used for trending 
lbound      	| the lower bound of the trend's confidence interval (zyp)
trend       	| the Sens' slope (trend) per unit time (zyp)
trendp      	| the Sen's slope (trend) over the time period (zyp)
ubound      	| the upper bound of the trend's confidence interval (zyp)
tau         	| Kendall's tau statistic computed on the final detrended timeseries (zyp)
sig	          | Kendall's P-value computed for the final detrended timeseries (zyp)
nruns	        | the number of runs required to converge upon a trend (zyp)
autocor	      | the autocorrelation of the final detrended timeseries (zyp)
valid_frac  	| the fraction of the data which is valid (not NA) once autocorrelation is removed (zyp)
linear      	| the least squares fit trend on the same data (zyp)
intercept   	| the lower bound of the trend's confidence interval (zyp)
lbound	      | the intercept of the Sen's slope (trend) (zyp)
min_year    	| the minimum year used in the trending
max_year      | the maximum year used in the trending
n_years       | the number of years with data for trending
mean          | the mean of all values used for trending
median      	| the median of all values used for trending
min	          | the minimum of all values used for trending
max	          | the maximum of all values used for trending 

If the argument `incl_data` is TRUE, then each year of data will be appended on each row/statistics.

Example default:

```{r, eval=TRUE}
compute_annual_trends(station_number = "08NM116",
                      zyp_method = "yuepilon",
                      start_year = 1973, end_year = 2013)
```

Example with custom:
```{r, eval=TRUE}
compute_annual_trends(station_number = "08NM116",
                      zyp_method = "yuepilon",
                      start_year = 1973, end_year = 2013,
                      annual_percentiles = c(10,90),
                      monthly_percentiles = c(10,20),
                      stats_days = 1,
                      stats_align = "right",
                      lowflow_days = c(1,3,7,30),
                      lowflow_align = "right",
                      timing_percent = c(25,33,50,75),
                      normal_percentiles = c(25,75),
                      incl_data = TRUE)
```

## 3. Plotting Trends

To plot you need to a tibble of results with data

`trends_results`
`groups`
`zyp_alpha` to plot a line, NA if not


Example with custom:
```{r, eval=FALSE}
trends_results <- compute_annual_trends()
trends_plots <- plot_annual_trends(trends_results = trends_results,
                                   zyp_alpha = 0.05,
                                   groups = STATION_NUMBER)
trends_plots$Annual_somethinngggg

```



## References

References from zyp package:

- Wang, X.L. and Swail, V.R., 2001. Changes in extreme wave heights in northern hemisphere oceans and related atmospheric circulation regimes. Journal of Climate, 14: 2204-2221.
- Yue, S., P. Pilon, B. Phinney and G. Cavadias, 2002. The influence of autocorrelation on the ability to detect trend in hydrological series. Hydrological Processes, 16: 1807-1829.
- Zhang, X., Vincent, L.A., Hogg, W.D. and Niitsoo, A., 2000. Temperature and Precipitation Trends in Canada during the 20th Century. Atmosphere-Ocean 38(3): 395-429.
- Sen, P.K., 1968. Estimates of the Regression Coefficient Based on Kendall's Tau. Journal of the American Statistical Association Vol. 63, No. 324: 1379-1389.



